{
    "contents" : "library(RMySQL)\nlibrary (plyr)              \n\nSpecialPurpose <- setRefClass(\"SpecialPurpose\", \n                             fields = list(\n                               demographics=\"data.frame\",\n                               subject_visits=\"data.frame\"),\n                             methods = list(\n                               getSpecialPurpose = function(conn,study_id) {\n                                 demographics <<- getDemographics(conn,study_id)  \n                                 subject_visits <<- getSubjectVisits(conn,study_id)                                 \n                               }\n                             ))\n\nInterventions <- setRefClass(\"Interventions\", \n                                fields = list(\n                                  concomitant_medications=\"data.frame\",\n                                  exposure=\"data.frame\",\n                                  procedures=\"data.frame\",\n                                  substance_use=\"data.frame\"),\n                                methods = list(\n                                  getInterventions = function(conn,study_id) {\n                                    exposure <<- getExposure(conn, study_id)\n                                    concomitant_medications <<- getConcomitantMedications(conn, study_id)\n                                    substance_use <<- getSubstanceUse(conn, study_id)\n                                  }\n                              ))\n\nEvents <- setRefClass(\"Events\", fields = list(\n                                  adverse_events=\"data.frame\",\n                                  clinical_events=\"data.frame\",\n                                  disposition=\"data.frame\",\n                                  protocol_deviations=\"data.frame\",\n                                  healthcare_encounters=\"data.frame\",\n                                  medical_history =\"data.frame\"),\n                                methods = list(\n                                  getEvents = function(conn,study_id) {\n                                    adverse_events <<- getAdverseEvents(conn, study_id)\n                                    protocol_deviations <<- getProtocolDeviations(conn, study_id)\n                                    medical_history <<- getMedicalHistory(conn, study_id)\n                                  }\n                                ))\n\nFindings <- setRefClass(\"Findings\", \n                        fields = list(\n                                drug_accountability=\"data.frame\",\n                                death_details=\"data.frame\",\n                                ecg_test_results=\"data.frame\",\n                                ie_not_met=\"data.frame\",\n                                immunogenicity_specimen_assessment=\"data.frame\",\n                                laboratory_test_results=\"data.frame\",\n                                microbiology_specimen=\"data.frame\",\n                                microbiology_susceptibility=\"data.frame\",\n                                microscopic_findings=\"data.frame\",\n                                pharmacokinetics_concentrations=\"data.frame\",\n                                pharmacokinetics_parameters=\"data.frame\",\n                                physical_examination=\"data.frame\",\n                                questionnaires=\"data.frame\",\n                                reproductive_system_findings=\"data.frame\", \n                                subject_characteristics=\"data.frame\",\n                                subject_status=\"data.frame\",\n                                vital_signs=\"data.frame\",\n                                findings_about=\"data.frame\",\n                                skin_response=\"data.frame\",\n                                hai_results=\"data.frame\",\n                                elisa_results=\"data.frame\",\n                                elispot_results=\"data.frame\",\n                                neut_ab_titer_results=\"data.frame\",\n                                hla_typing_results=\"data.frame\",\n                                mbaa_results=\"data.frame\",\n                                pcr_results=\"data.frame\",\n                                fcs_results=\"data.frame\",\n                                array_results=\"data.frame\"),\n                        methods = list(\n                          getFindings = function(conn,study_id) {\n                            laboratory_test_results <<- getLaboratoryTestResults(conn, study_id)\n                            vital_signs <<- getVitalSigns(conn, study_id)\n                            physical_examination <<- getPhysicalExamination(conn, study_id)\n                            findings_about <<- getFindingsAbout(conn, study_id)\n                            hai_results <<- getHaiResults(conn, study_id)\n                            elisa_results <<- getElisaResults(conn, study_id)\n                            elispot_results <<- getElispotResults(conn, study_id)\n                            neut_ab_titer_results <<- getNeutAbTiterResults(conn, study_id)\n                            hla_typing_results <<- getHlaTypingResults(conn, study_id)\n                            mbaa_results <<- getMbaaResults(conn, study_id)\n                            pcr_results <<- getPcrResults(conn, study_id)\n                            fcs_results <<- getFcsResults(conn, study_id)\n                            array_results <<- getArrayResults(conn, study_id)\n                          }\n                        ))\n\nStudyDetails <- setRefClass(\"StudyDetails\", \n                        fields = list(\n                          arms=\"data.frame\",\n                          summary=\"data.frame\",\n                          eligibility_criteria=\"data.frame\"),\n                        methods = list(\n                          getStudyDetails = function(conn,study_id) {\n                            arms <<- getArms(conn, study_id)\n                            summary <<- getStudySummary(conn, study_id) \n                            eligibility_criteria <<- getEligibilityCriteria(conn, study_id) \n                          }\n                        ))\nAnalyses <- setRefClass(\"Analyses\", \n                        fields = list(\n                          subject_basic_analyses=\"data.frame\"),\n                        methods = list(\n                          getAnalyses = function(conn,study_id) {\n                            subject_basic_analyses <<- getSubjectBasicAnalyses(conn, study_id)\n                          }\n                        ))\n\nStudy <- setRefClass(\"Study\", fields = list(\n  special_purpose=\"SpecialPurpose\",\n  interventions=\"Interventions\",\n  events=\"Events\",\n  findings=\"Findings\",\n  study_details=\"StudyDetails\",\n  analyses=\"Analyses\"),\n  methods = list(\n    getTableOfContents = function() {\n      contents.l <- list(\n                    r1=list(c1=\"Special Purpose\", c2=\"Demographics\", c3=\"\"), \n                    r2=list(c1=\"Special Purpose\", c2=\"Subject Visits\", c3=\"\"), \n                    r4=list(c1=\"Interventions\", c2=\"Concomitant Medications\", c3=\"\"), \n                    r5=list(c1=\"Interventions\", c2=\"Exposure\", c3=\"\"), \n                    r6=list(c1=\"Interventions\", c2=\"Procedures\", c3=\"\"), \n                    r7=list(c1=\"Interventions\", c2=\"Substance Use\", c3=\"\"), \n                    r8=list(c1=\"Events\", c2=\"Adverse Events\", c3=\"\"), \n                    r9=list(c1=\"Events\", c2=\"Clinical Events\", c3=\"\"), \n                    r11=list(c1=\"Events\", c2=\"Protocol Deviations\", c3=\"\"), \n                    r13=list(c1=\"Events\", c2=\"Medical History\", c3=\"\"), \n                    r14=list(c1=\"Events\", c2=\"Family History\", c3=\"\"), \n                    r15=list(c1=\"Findings\", c2=\"Drug Accountability\", c3=\"\"), \n                    r16=list(c1=\"Findings\", c2=\"Death Details\", c3=\"\"), \n                    r17=list(c1=\"Findings\", c2=\"ECG Test Results\", c3=\"\"), \n                    r20=list(c1=\"Findings\", c2=\"Laboratory Test Results\", c3=\"\"),  \n                    r28=list(c1=\"Findings\", c2=\"Questionnaires\", c3=\"\"),  \n                    r32=list(c1=\"Findings\", c2=\"Vital Signs\", c3=\"\"), \n                    r33=list(c1=\"Findings\", c2=\"Findings About\", c3=\"\"), \n                    r34=list(c1=\"Findings\", c2=\"HAI Results\", c3=\"\"), \n                    r35=list(c1=\"Findings\", c2=\"ELISA Results\", c3=\"\"), \n                    r36=list(c1=\"Findings\", c2=\"ELISPOT Results\", c3=\"\"), \n                    r37=list(c1=\"Findings\", c2=\"Neut Ab Titer Results\", c3=\"\"),                     \n                    r38=list(c1=\"Findings\", c2=\"HLA Typing Results\", c3=\"\"), \n                    r39=list(c1=\"Findings\", c2=\"PCR Results\", c3=\"\"), \n                    r40=list(c1=\"Findings\", c2=\"FCS Results\", c3=\"\"), \n                    r41=list(c1=\"Findings\", c2=\"Array Results\", c3=\"\"), \n                    r42=list(c1=\"Analyses\", c2=\"Subject Basic Analyses\", c3=\"\"), \n                    r43=list(c1=\"Study Details\", c2=\"Study Visits\", c3=\"\"), \n                    r44=list(c1=\"Study Details\", c2=\"Study Assessments\", c3=\"\"), \n                    r45=list(c1=\"Study Details\", c2=\"Study Eligibility Criteria\", c3=\"\"), \n                    r46=list(c1=\"Study Details\", c2=\"Study Arms\", c3=\"\"), \n                    r47=list(c1=\"Study Details\", c2=\"Study Summary\", c3=\"\"))\n    \n      contents.df <- ldply (contents.l, data.frame, stringsAsFactors = FALSE)\n      \n      contents.df$.id <- NULL\n      colnames(contents.df) <- c(\"Class\", \"Domain\", \"Included?\")\n      \n      \n      \n      if (nrow(special_purpose$demographics) > 0)\n        contents.df[contents.df$Domain == \"Demographics\",3] <- \"yes\"\n      if (nrow(special_purpose$subject_visits) > 0)\n        contents.df[contents.df$Domain == \"Subject Visits\",3] <- \"yes\"\n      if (nrow(interventions$concomitant_medications) > 0)\n        contents.df[contents.df$Domain == \"Concomitant Medications\",3] <- \"yes\"\n      if (nrow(interventions$exposure) > 0)\n        contents.df[contents.df$Domain == \"Exposure\",3] <- \"yes\"\n      if (nrow(interventions$procedures) > 0)\n        contents.df[contents.df$Domain == \"Procedures\",3] <- \"yes\"\n      if (nrow(interventions$substance_use) > 0)\n        contents.df[contents.df$Domain == \"Substance Use\",3] <- \"yes\"\n      if (nrow(events$adverse_events) > 0)\n        contents.df[contents.df$Domain == \"Adverse Events\",3] <- \"yes\"\n      if (nrow(events$protocol_deviations) > 0)\n        contents.df[contents.df$Domain == \"Protocol Deviations\",3] <- \"yes\"\n      if (nrow(events$medical_history) > 0)\n        contents.df[contents.df$Domain == \"Medical History\",3] <- \"yes\"\n      if (nrow(findings$laboratory_test_results) > 0)\n        contents.df[contents.df$Domain == \"Laboratory Test Results\",3] <- \"yes\"\n      if (nrow(findings$vital_signs) > 0)\n        contents.df[contents.df$Domain == \"Vital Signs\",3] <- \"yes\"\n      if (nrow(findings$findings_about) > 0)\n        contents.df[contents.df$Domain == \"Findings About\",3] <- \"yes\"\n      if (nrow(findings$hai_results) > 0)\n        contents.df[contents.df$Domain == \"HAI Results\",3] <- \"yes\"      \n      if (nrow(findings$elisa_results) > 0)\n        contents.df[contents.df$Domain == \"ELISA Results\",3] <- \"yes\"\n      if (nrow(findings$elispot_results) > 0)\n        contents.df[contents.df$Domain == \"ELISPOT Results\",3] <- \"yes\"      \n      if (nrow(findings$neut_ab_titer_results) > 0)\n        contents.df[contents.df$Domain == \"Neut Ab Titer Results\",3] <- \"yes\"      \n      if (nrow(findings$hla_typing_results) > 0)\n        contents.df[contents.df$Domain == \"HLA Typing Results\",3] <- \"yes\"      \n      if (nrow(findings$pcr_results) > 0)\n        contents.df[contents.df$Domain == \"PCR Results\",3] <- \"yes\"      \n      if (nrow(findings$fcs_results) > 0)\n        contents.df[contents.df$Domain == \"FCS Results\",3] <- \"yes\"            \n      if (nrow(findings$array_results) > 0)\n        contents.df[contents.df$Domain == \"Array Results\",3] <- \"yes\"      \n      if (nrow(analyses$subject_basic_analyses) > 0)\n        contents.df[contents.df$Domain == \"Subject Basic Analyses\",3] <- \"yes\"\n      if (nrow(study_details$eligibility_criteria) > 0)\n        contents.df[contents.df$Domain == \"Study Eligibility Criteria\",3] <- \"yes\"      \n      if (nrow(study_details$arms) > 0)\n        contents.df[contents.df$Domain == \"Study Arms\",3] <- \"yes\"\n      if (nrow(study_details$summary) > 0)\n        contents.df[contents.df$Domain == \"Study Summary\",3] <- \"yes\"\n      \n      contents.df\n    }\n))\n\ngetStudyFromDatabase <- function(conn,study_id) {\n  cat(\"loading Study ID = \", study_id, \"\\n\")\n  \n  study <- Study$new()\n  \n  study$special_purpose$getSpecialPurpose(conn, study_id)\n  study$interventions$getInterventions(conn, study_id) \n  study$events$getEvents(conn, study_id)\n  study$findings$getFindings(conn, study_id)\n  study$study_details$getStudyDetails(conn, study_id)  \n  study$analyses$getAnalyses(conn, study_id)\n  \n  cat(\"done loading Study ID = \", study_id, \"\\n\")\n\n  study\n}\n\ngetDemographicsOfStudies <- function(conn,study_ids) {\n  all.df <- data.frame()\n  for (study_id in study_ids) {\n    all.df <- rbind(all.df, getDemographics(conn, study_id))\n  }\n  all.df\n}\n\ngetStudiesWithFcsResults <- function(conn) {\n  study_column_names <- c(\"study_id\", \"title\", \"fcs_count\")\n      \n    sql_stmt <- paste(\"\n                      SELECT distinct\n                        s.study_accession,\n                        s.brief_title,\n                        count(fi.file_info_id)\n                      FROM study s,\n                        biosample bs,\n                        experiment ex,\n                        biosample_2_expsample bs2es,\n                        expsample_2_file_info es2fi,\n                        file_info fi\n                      WHERE s.study_accession=bs.study_accession AND \n                        bs.biosample_accession=bs2es.biosample_accession AND\n                        bs2es.experiment_accession=ex.experiment_accession AND\n                        bs2es.expsample_accession=es2fi.expsample_accession AND \n                        es2fi.file_info_id=fi.file_info_id AND \n                        fi.detail IN (\\\"Flow cytometry result in fcs format\\\") AND \n                        fi.purpose IN (\\\"Flow cytometry result\\\")\n                      GROUP BY s.study_accession\", sep=\"\")\n  \n  studies_df <- dbGetQuery(conn,statement=sql_stmt)\n  if (nrow(studies_df) > 0)\n    colnames(studies_df) <- study_column_names \n  studies_df  \n}\n\ngetStudySummaryOfStudies <- function(conn,study_ids) {\n  all.ss <- data.frame()\n  for (study_id in study_ids) {\n    all.ss <- rbind(all.ss, getStudySummary(conn, study_id))\n  }\n  all.ss\n}\n\ngetListOfStudyIds <- function(conn) {\n  sql_stmt <- paste(\"\n                SELECT distinct\n                  s.study_accession\n                  FROM study s\", sep=\"\")\n  \n  study_ids <- dbGetQuery(conn,statement=sql_stmt)\n  study_ids[['study_accession']]\n} \n\nloadAndSaveStudyData  <- function(conn,study_ids, data_dir) {\n  for (study_id in study_ids) {\n    study = getStudyFromDatabase(conn, study_id) \n    saveRDS(study, file=paste(data_dir, gsub(\"'\", '', study_id),\".rds\", sep=\"\")) \n  }\n}\n\ngetStudy <- function(study_id, data_dir) {\n  readRDS(paste(data_dir, gsub(\"'\", '', study_id),\".rds\", sep=\"\"))\n}\n",
    "created" : 1424814452476.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "987134584",
    "id" : "CBDE104D",
    "lastKnownWriteTime" : 1424815570,
    "path" : "~/Projects/RImmPort/R/Study.R",
    "project_path" : "R/Study.R",
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_source"
}